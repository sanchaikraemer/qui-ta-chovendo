<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>aqui ta chovendo, e ai?</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,.10);
      --line:rgba(255,255,255,.16);
      --text:#f8fafc;
      --muted:rgba(248,250,252,.70);
      --shadow:0 18px 46px rgba(0,0,0,.50);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; background:var(--bg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #app{height:100%; width:100%; position:relative; overflow:hidden}
    #map{height:100%; width:100%}

    .top{
      position:absolute; top:10px; left:10px; right:10px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      z-index:999;
      pointer-events:none;
    }
    .chip{
      pointer-events:auto;
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      background:rgba(11,18,32,.55);
      backdrop-filter: blur(10px);
      border-radius:999px;
      color:var(--text);
      font-weight:800;
      font-size:12px;
      box-shadow:var(--shadow);
      white-space:nowrap;
    }
    .chip small{font-weight:700; color:var(--muted)}
    .chipBtn{
      pointer-events:auto;
      cursor:pointer;
      border:1px solid var(--line);
      background:rgba(11,18,32,.55);
      backdrop-filter: blur(10px);
      border-radius:999px;
      padding:8px 10px;
      color:var(--text);
      font-weight:900;
      font-size:12px;
      box-shadow:var(--shadow);
      white-space:nowrap;
    }

    .sheet{
      position:absolute; left:10px; right:10px; bottom:10px;
      z-index:999;
      border:1px solid var(--line);
      background:rgba(11,18,32,.72);
      backdrop-filter: blur(12px);
      box-shadow:var(--shadow);
      border-radius:22px;
      padding:12px;
    }
    .title{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .title h1{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
      color:var(--text);
      line-height:1.2;
    }
    .title p{
      margin:4px 0 0;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .row{
      display:flex; gap:10px; margin-top:10px;
    }
    .btn{
      all:unset;
      cursor:pointer;
      flex:1;
      display:flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 12px;
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:var(--text);
      font-weight:900;
      font-size:14px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform: translateY(1px)}
    .btn .icon{font-size:18px}
    .meta{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
    }
    .meta b{color:var(--text)}
    .msg{
      margin-top:8px;
      font-size:12px;
      color:#fecaca;
      display:none;
    }

    .wxMarker{
      font-size:22px;
      line-height:22px;
      filter: drop-shadow(0 8px 10px rgba(0,0,0,.45));
      transform: translate(-50%, -50%);
      will-change: opacity;
    }

    @media (max-width:380px){
      .btn{font-size:13px; padding:11px 10px}
      .wxMarker{font-size:20px}
    }
  </style>
</head>

<body>
<div id="app">
  <div id="map"></div>

  <div class="top">
    <div class="chip" id="chipLoc">üìç <span>Localizando‚Ä¶</span></div>
    <button class="chipBtn" id="btnCenter">Centralizar</button>
  </div>

  <div class="sheet">
    <div class="title">
      <div>
        <h1>aqui ta chovendo, e ai?</h1>
        <p id="sub">Pra ver o mapa, responda: est√° chovendo a√≠ agora?</p>
      </div>
      <div class="chip" id="chipPts">üë• <small>pontos</small> <span id="ptCount">0</span></div>
    </div>

    <div class="row">
      <button class="btn" id="btnSim"><span class="icon">üíß</span>Sim</button>
      <button class="btn" id="btnNao"><span class="icon">‚òÄÔ∏è</span>N√£o</button>
    </div>

    <div class="meta">
      <span>Raio: <b>100km</b></span>
      <span>Validade: <b>3h</b></span>
      <span>Zoom m√°x: <b>RS</b></span>
    </div>

    <div class="msg" id="msg"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  /***************
   * CONFIG
   ***************/
  const SUPABASE_URL = "https://lnrbpiklzymblpyrobwx.supabase.co";
  // ‚ö†Ô∏è cole a chave COMPLETA aqui (n√£o pode faltar nenhum caractere)
  const SUPABASE_ANON_KEY = "sb_publishable_KXVbF3c7RGFXVTtfYmrzzg_dMK04Q9q";

  const TABLE = "reports";
  const TTL_HOURS = 3;
  const RADIUS_KM = 100;
  const START_RADIUS_KM = 5;
  const MAX_POINTS_FETCH = 2000;

  const RS_BOUNDS = L.latLngBounds(
    L.latLng(-33.75, -57.75),
    L.latLng(-26.00, -49.70)
  );

  /***************
   * STATE
   ***************/
  const $ = (id) => document.getElementById(id);
  let map, userLatLng = null;
  let userMarker = null;
  let radiusCircle100 = null;
  let radiusCircle5 = null;
  let markersLayer = L.layerGroup();
  let lastFetchTimer = null;

  /***************
   * HELPERS
   ***************/
  function showMsg(text){
    $("msg").style.display = text ? "block" : "none";
    $("msg").textContent = text || "";
  }
  function nowMs(){ return Date.now(); }

  function haversineKm(a, b){
    const R = 6371;
    const toRad = (x)=> x * Math.PI/180;
    const dLat = toRad(b.lat - a.lat);
    const dLon = toRad(b.lng - a.lng);
    const lat1 = toRad(a.lat);
    const lat2 = toRad(b.lat);
    const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
    return 2 * R * Math.asin(Math.sqrt(s));
  }

  function ageHours(createdAtIso){
    const t = new Date(createdAtIso).getTime();
    return (nowMs() - t) / (1000*60*60);
  }

  function opacityByHour(createdAtIso){
    const h = ageHours(createdAtIso);
    if (h < 1) return 1.0;
    if (h < 2) return 0.66;
    if (h < 3) return 0.33;
    return 0.0;
  }

  function makeEmojiIcon(emoji, opacity){
    return L.divIcon({
      className: "",
      html: `<div class="wxMarker" style="opacity:${opacity}">${emoji}</div>`,
      iconSize: [0,0],
      iconAnchor: [0,0]
    });
  }

  function setChipLoc(text){
    $("chipLoc").querySelector("span").textContent = text;
  }

  /***************
   * SUPABASE REST
   ***************/
  function supabaseHeaders(){
    return {
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    };
  }

  function getDeviceId(){
    let id = localStorage.getItem("w_device_id");
    if(!id){
      id = (crypto?.randomUUID?.() || ("id_" + Math.random().toString(16).slice(2) + Date.now()));
      localStorage.setItem("w_device_id", id);
    }
    return id;
  }

  async function supabaseUpsertReport(lat, lon, raining){
    const device_id = getDeviceId();
    const url = `${SUPABASE_URL}/rest/v1/${TABLE}?on_conflict=device_id`;
    const res = await fetch(url, {
      method: "POST",
      headers: { ...supabaseHeaders(), "Prefer":"resolution=merge-duplicates,return=minimal" },
      body: JSON.stringify([{ device_id, lat, lon, raining }])
    });
    if(!res.ok){
      const txt = await res.text().catch(()=> "");
      throw new Error(`Falha ao salvar (${res.status}). ${txt}`);
    }
  }

  async function supabaseFetchRecent(){
    const since = new Date(nowMs() - TTL_HOURS*60*60*1000).toISOString();
    const url =
      `${SUPABASE_URL}/rest/v1/${TABLE}` +
      `?select=lat,lon,raining,created_at` +
      `&created_at=gte.${encodeURIComponent(since)}` +
      `&order=created_at.desc` +
      `&limit=${MAX_POINTS_FETCH}`;

    const res = await fetch(url, { headers: supabaseHeaders() });
    if(!res.ok){
      const txt = await res.text().catch(()=> "");
      throw new Error(`Falha ao buscar (${res.status}). ${txt}`);
    }
    return await res.json();
  }

  /***************
   * MAP
   ***************/
  function initMap(){
    map = L.map("map", {
      zoomControl: false,
      attributionControl: true,
      maxBounds: RS_BOUNDS,
      maxBoundsViscosity: 0.9
    });

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      minZoom: 6
    }).addTo(map);

    L.control.zoom({ position:"bottomright" }).addTo(map);
    markersLayer.addTo(map);

    map.fitBounds(RS_BOUNDS.pad(-0.10));
  }

  function setUserOnMap(lat, lon){
    userLatLng = L.latLng(lat, lon);

    if(userMarker) map.removeLayer(userMarker);
    userMarker = L.circleMarker(userLatLng, {
      radius: 7,
      weight: 2,
      color: "#ffffff",
      fillColor: "#3b82f6",
      fillOpacity: 0.9
    }).addTo(map);

    if(radiusCircle5) map.removeLayer(radiusCircle5);
    radiusCircle5 = L.circle(userLatLng, {
      radius: START_RADIUS_KM * 1000,
      weight: 1,
      color: "rgba(255,255,255,.35)",
      fillColor: "rgba(255,255,255,.06)",
      fillOpacity: 0.15
    }).addTo(map);

    if(radiusCircle100) map.removeLayer(radiusCircle100);
    radiusCircle100 = L.circle(userLatLng, {
      radius: RADIUS_KM * 1000,
      weight: 1,
      color: "rgba(255,255,255,.22)",
      fillColor: "rgba(255,255,255,.04)",
      fillOpacity: 0.10
    }).addTo(map);

    // ‚úÖ abre perto (ruas)
    map.setView(userLatLng, 15);
    map.setMinZoom(6);
  }

  function center(){
    if(!userLatLng) return;
    map.setView(userLatLng, 15);
  }

  /***************
   * RENDER POINTS
   ***************/
  function clearPoints(){
    markersLayer.clearLayers();
    $("ptCount").textContent = "0";
  }

  function renderPoints(points){
    clearPoints();
    if(!userLatLng) return;

    let count = 0;

    for(const p of points){
      const lat = Number(p.lat);
      const lon = Number(p.lon);
      if(!Number.isFinite(lat) || !Number.isFinite(lon)) continue;

      const ll = L.latLng(lat, lon);
      if(!RS_BOUNDS.contains(ll)) continue;

      const d = haversineKm(userLatLng, ll);
      if(d > RADIUS_KM) continue;

      const op = opacityByHour(p.created_at);
      if(op <= 0) continue;

      const emoji = p.raining ? "üíß" : "‚òÄÔ∏è";
      const icon = makeEmojiIcon(emoji, op);

      L.marker(ll, { icon }).addTo(markersLayer);
      count++;
    }

    $("ptCount").textContent = String(count);
  }

  async function refreshPoints(){
    if(!SUPABASE_URL.includes("http") || SUPABASE_ANON_KEY.includes("COLE_AQUI")){
      showMsg("Configure SUPABASE_URL e SUPABASE_ANON_KEY no c√≥digo.");
      return;
    }
    if(!userLatLng) return;

    try{
      const points = await supabaseFetchRecent();
      renderPoints(points);
      showMsg("");
    }catch(err){
      showMsg(String(err.message || err));
    }
  }

  function startAutoRefresh(){
    if(lastFetchTimer) clearInterval(lastFetchTimer);
    lastFetchTimer = setInterval(refreshPoints, 45 * 1000);
  }

  /***************
   * GEOLOCATION
   ***************/
  function getLocation(){
    setChipLoc("Localizando‚Ä¶");
    showMsg("");

    if(!navigator.geolocation){
      setChipLoc("Sem geolocaliza√ß√£o");
      showMsg("Seu navegador n√£o suporta geolocaliza√ß√£o.");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        const ll = L.latLng(lat, lon);
        if(!RS_BOUNDS.contains(ll)){
          setChipLoc("Fora do RS");
          showMsg("Este app est√° limitado ao Rio Grande do Sul.");
          map.fitBounds(RS_BOUNDS.pad(-0.10));
          return;
        }

        setChipLoc("Localiza√ß√£o OK");
        setUserOnMap(lat, lon);
        refreshPoints();
        startAutoRefresh();
      },
      ()=>{
        setChipLoc("Permiss√£o negada");
        showMsg("Ative a localiza√ß√£o para usar o app.");
      },
      { enableHighAccuracy:true, timeout:12000, maximumAge:60000 }
    );
  }

  /***************
   * VOTE
   ***************/
  async function vote(raining){
    if(!userLatLng){
      showMsg("Ative a localiza√ß√£o primeiro.");
      return;
    }
    if(!SUPABASE_URL.includes("http") || SUPABASE_ANON_KEY.includes("COLE_AQUI")){
      showMsg("Configure SUPABASE_URL e SUPABASE_ANON_KEY no c√≥digo.");
      return;
    }

    try{
      showMsg("");
      await supabaseUpsertReport(userLatLng.lat, userLatLng.lng, raining);
      await refreshPoints();
    }catch(err){
      showMsg(String(err.message || err));
    }
  }

  /***************
   * EVENTS
   ***************/
  $("btnSim").addEventListener("click", ()=> vote(true));
  $("btnNao").addEventListener("click", ()=> vote(false));
  $("btnCenter").addEventListener("click", center);

  /***************
   * INIT
   ***************/
  initMap();
  getLocation();
</script>
</body>
</html>
